{"version":3,"sources":["../../../../build/webpack/plugins/profiling-plugin.ts"],"sourcesContent":["import { webpack, isWebpack5 } from 'next/dist/compiled/webpack/webpack'\nimport { trace, stackPush, stackPop, Span } from '../../../telemetry/trace'\n\nconst pluginName = 'ProfilingPlugin'\nexport const spans = new WeakMap<any, Span>()\n\nfunction getNormalModuleLoaderHook(compilation: any) {\n  if (isWebpack5) {\n    // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n    return webpack.NormalModule.getCompilationHooks(compilation).loader\n  }\n\n  return compilation.hooks.normalModuleLoader\n}\n\nexport class ProfilingPlugin {\n  compiler: any\n\n  apply(compiler: any) {\n    this.traceTopLevelHooks(compiler)\n    this.traceCompilationHooks(compiler)\n    this.compiler = compiler\n  }\n\n  traceHookPair(\n    spanName: string,\n    startHook: any,\n    stopHook: any,\n    attrs?: any,\n    onSetSpan?: (span: Span) => void\n  ) {\n    let span: Span | undefined\n    startHook.tap(pluginName, () => {\n      span = stackPush(this.compiler, spanName, attrs)\n      onSetSpan?.(span)\n    })\n    stopHook.tap(pluginName, () => {\n      // `stopHook` may be triggered when `startHook` has not in cases\n      // where `stopHook` is used as the terminating event for more\n      // than one pair of hooks.\n      if (!span) {\n        return\n      }\n      stackPop(this.compiler, span)\n    })\n  }\n\n  traceLoopedHook(spanName: string, startHook: any, stopHook: any) {\n    let span: Span | undefined\n    startHook.tap(pluginName, () => {\n      if (!span) {\n        span = stackPush(this.compiler, spanName)\n      }\n    })\n    stopHook.tap(pluginName, () => {\n      stackPop(this.compiler, span)\n    })\n  }\n\n  traceTopLevelHooks(compiler: any) {\n    this.traceHookPair(\n      'webpack-compile',\n      compiler.hooks.compile,\n      compiler.hooks.done,\n      () => {\n        return { name: compiler.name }\n      },\n      (span) => spans.set(compiler, span)\n    )\n    this.traceHookPair(\n      'webpack-prepare-env',\n      compiler.hooks.environment,\n      compiler.hooks.afterEnvironment\n    )\n    if (compiler.options.mode === 'development') {\n      this.traceHookPair(\n        'webpack-invalidated',\n        compiler.hooks.invalid,\n        compiler.hooks.done,\n        () => ({ name: compiler.name })\n      )\n    }\n  }\n\n  traceCompilationHooks(compiler: any) {\n    if (isWebpack5) {\n      this.traceHookPair(\n        'webpack-compilation',\n        compiler.hooks.beforeCompile,\n        compiler.hooks.afterCompile,\n        () => ({ name: compiler.name })\n      )\n    }\n\n    compiler.hooks.compilation.tap(pluginName, (compilation: any) => {\n      compilation.hooks.buildModule.tap(pluginName, (module: any) => {\n        const compilerSpan = spans.get(compiler)\n        if (!compilerSpan) {\n          return\n        }\n\n        const span = trace('build-module', compilerSpan.id)\n        span.setAttribute('name', module.userRequest)\n        spans.set(module, span)\n      })\n\n      getNormalModuleLoaderHook(compilation).tap(\n        pluginName,\n        (loaderContext: any, module: any) => {\n          const parentSpan = spans.get(module)\n          loaderContext.currentTraceSpan = parentSpan\n        }\n      )\n\n      compilation.hooks.succeedModule.tap(pluginName, (module: any) => {\n        spans.get(module)?.stop()\n      })\n\n      this.traceHookPair(\n        'webpack-compilation-chunk-graph',\n        compilation.hooks.beforeChunks,\n        compilation.hooks.afterChunks\n      )\n      this.traceHookPair(\n        'webpack-compilation-optimize',\n        compilation.hooks.optimize,\n        compilation.hooks.reviveModules\n      )\n      this.traceLoopedHook(\n        'webpack-compilation-optimize-modules',\n        compilation.hooks.optimizeModules,\n        compilation.hooks.afterOptimizeModules\n      )\n      this.traceLoopedHook(\n        'webpack-compilation-optimize-chunks',\n        compilation.hooks.optimizeChunks,\n        compilation.hooks.afterOptimizeChunks\n      )\n      this.traceHookPair(\n        'webpack-compilation-optimize-tree',\n        compilation.hooks.optimizeTree,\n        compilation.hooks.afterOptimizeTree\n      )\n      this.traceHookPair(\n        'webpack-compilation-hash',\n        compilation.hooks.beforeHash,\n        compilation.hooks.afterHash\n      )\n    })\n  }\n}\n"],"names":[],"mappings":"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"}
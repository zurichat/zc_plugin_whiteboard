{"version":3,"sources":["../../build/compiler.ts"],"sourcesContent":["import { webpack } from 'next/dist/compiled/webpack/webpack'\n\nexport type CompilerResult = {\n  errors: string[]\n  warnings: string[]\n}\n\nfunction generateStats(\n  result: CompilerResult,\n  stat: webpack.Stats\n): CompilerResult {\n  const { errors, warnings } = stat.toJson('errors-warnings')\n  if (errors.length > 0) {\n    result.errors.push(...errors)\n  }\n\n  if (warnings.length > 0) {\n    result.warnings.push(...warnings)\n  }\n\n  return result\n}\n\n// Webpack 5 requires the compiler to be closed (to save caches)\n// Webpack 4 does not have this close method so in order to be backwards compatible we check if it exists\nfunction closeCompiler(compiler: webpack.Compiler | webpack.MultiCompiler) {\n  return new Promise<void>((resolve, reject) => {\n    if ('close' in compiler) {\n      // @ts-ignore Close only exists on the compiler in webpack 5\n      return compiler.close((err: any) => (err ? reject(err) : resolve()))\n    }\n\n    resolve()\n  })\n}\n\nexport function runCompiler(\n  config: webpack.Configuration | webpack.Configuration[]\n): Promise<CompilerResult> {\n  return new Promise((resolve, reject) => {\n    const compiler = webpack(config)\n    compiler.run(\n      (\n        err: Error,\n        statsOrMultiStats: { stats: webpack.Stats[] } | webpack.Stats\n      ) => {\n        closeCompiler(compiler).then(() => {\n          if (err) {\n            const reason = err?.toString()\n            if (reason) {\n              return resolve({ errors: [reason], warnings: [] })\n            }\n            return reject(err)\n          }\n\n          if ('stats' in statsOrMultiStats) {\n            const result: CompilerResult = statsOrMultiStats.stats.reduce(\n              generateStats,\n              { errors: [], warnings: [] }\n            )\n            return resolve(result)\n          }\n\n          const result = generateStats(\n            { errors: [], warnings: [] },\n            statsOrMultiStats\n          )\n          return resolve(result)\n        })\n      }\n    )\n  })\n}\n"],"names":[],"mappings":";;;;QAoCgB,WAAW,GAAX,WAAW;AApCH,GAAoC,CAApC,QAAoC;SAOnD,aAAa,CACpB,MAAsB,EACtB,IAAmB,EACH,CAAC;IACjB,KAAK,GAAG,MAAM,GAAE,QAAQ,MAAK,IAAI,CAAC,MAAM,EAAC,eAAiB;IAC1D,EAAE,EAAE,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;QACtB,MAAM,CAAC,MAAM,CAAC,IAAI,IAAI,MAAM;IAC9B,CAAC;IAED,EAAE,EAAE,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;QACxB,MAAM,CAAC,QAAQ,CAAC,IAAI,IAAI,QAAQ;IAClC,CAAC;WAEM,MAAM;AACf,CAAC;AAED,EAAgE,AAAhE,8DAAgE;AAChE,EAAyG,AAAzG,uGAAyG;SAChG,aAAa,CAAC,QAAkD,EAAE,CAAC;WACnE,GAAG,CAAC,OAAO,EAAQ,OAAO,EAAE,MAAM,GAAK,CAAC;QAC7C,EAAE,GAAE,KAAO,KAAI,QAAQ,EAAE,CAAC;YACxB,EAA4D,AAA5D,0DAA4D;mBACrD,QAAQ,CAAC,KAAK,EAAE,GAAQ,GAAM,GAAG,GAAG,MAAM,CAAC,GAAG,IAAI,OAAO;;QAClE,CAAC;QAED,OAAO;IACT,CAAC;AACH,CAAC;SAEe,WAAW,CACzB,MAAuD,EAC9B,CAAC;WACnB,GAAG,CAAC,OAAO,EAAE,OAAO,EAAE,MAAM,GAAK,CAAC;QACvC,KAAK,CAAC,QAAQ,OAxCM,QAAoC,UAwC/B,MAAM;QAC/B,QAAQ,CAAC,GAAG,EAER,GAAU,EACV,iBAA6D,GAC1D,CAAC;YACJ,aAAa,CAAC,QAAQ,EAAE,IAAI,KAAO,CAAC;gBAClC,EAAE,EAAE,GAAG,EAAE,CAAC;oBACR,KAAK,CAAC,MAAM,GAAG,GAAG,aAAH,GAAG,UAAH,CAAa,QAAb,CAAa,GAAb,GAAG,CAAE,QAAQ;oBAC5B,EAAE,EAAE,MAAM,EAAE,CAAC;+BACJ,OAAO;4BAAG,MAAM;gCAAG,MAAM;;4BAAG,QAAQ;;oBAC7C,CAAC;2BACM,MAAM,CAAC,GAAG;gBACnB,CAAC;gBAED,EAAE,GAAE,KAAO,KAAI,iBAAiB,EAAE,CAAC;oBACjC,KAAK,CAAC,MAAM,GAAmB,iBAAiB,CAAC,KAAK,CAAC,MAAM,CAC3D,aAAa;wBACX,MAAM;wBAAM,QAAQ;;2BAEjB,OAAO,CAAC,MAAM;gBACvB,CAAC;gBAED,KAAK,CAAC,MAAM,GAAG,aAAa;oBACxB,MAAM;oBAAM,QAAQ;mBACtB,iBAAiB;uBAEZ,OAAO,CAAC,MAAM;YACvB,CAAC;QACH,CAAC;IAEL,CAAC;AACH,CAAC"}
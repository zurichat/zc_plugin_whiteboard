{"version":3,"sources":["../../../../telemetry/trace/report/to-zipkin.ts"],"sourcesContent":["import retry from 'next/dist/compiled/async-retry'\nimport { randomBytes } from 'crypto'\nimport fetch from 'node-fetch'\nimport * as Log from '../../../build/output/log'\n\nlet traceId = process.env.TRACE_ID\nlet batch: ReturnType<typeof batcher> | undefined\n\nconst localEndpoint = {\n  serviceName: 'nextjs',\n  ipv4: '127.0.0.1',\n  port: 9411,\n}\nconst zipkinUrl = `http://${localEndpoint.ipv4}:${localEndpoint.port}`\nconst zipkinAPI = `${zipkinUrl}/api/v2/spans`\n\ntype Event = {\n  traceId: string\n  parentId?: string\n  name: string\n  id: string\n  timestamp: number\n  duration: number\n  localEndpoint: typeof localEndpoint\n  tags?: Object\n}\n\n// Batch events as zipkin allows for multiple events to be sent in one go\nfunction batcher(reportEvents: (evts: Event[]) => void) {\n  const events: Event[] = []\n  let timeout: ReturnType<typeof setTimeout> | undefined\n  return (event: Event) => {\n    events.push(event)\n    // setTimeout is used instead of setInterval to ensure events sending does not block exiting the program\n    if (!timeout) {\n      timeout = setTimeout(() => {\n        reportEvents(events.slice())\n        events.length = 0\n        timeout = undefined\n      }, 1500)\n    }\n  }\n}\n\nconst reportToLocalHost = (\n  name: string,\n  duration: number,\n  timestamp: number,\n  id: string,\n  parentId?: string,\n  attrs?: Object\n) => {\n  if (!traceId) {\n    traceId = process.env.TRACE_ID = randomBytes(8).toString('hex')\n    Log.info(\n      `Zipkin trace will be available on ${zipkinUrl}/zipkin/traces/${traceId}`\n    )\n  }\n\n  if (!batch) {\n    batch = batcher((events) => {\n      // Ensure ECONNRESET error is retried 3 times before erroring out\n      retry(\n        () =>\n          // Send events to zipkin\n          fetch(zipkinAPI, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(events),\n          }),\n        { minTimeout: 500, retries: 3, factor: 1 }\n      ).catch(console.log)\n    })\n  }\n\n  batch({\n    traceId,\n    parentId,\n    name,\n    id,\n    timestamp,\n    duration,\n    localEndpoint,\n    tags: attrs,\n  })\n}\n\nexport default reportToLocalHost\n"],"names":[],"mappings":";;;;;AAAkB,GAAgC,CAAhC,WAAgC;AACtB,GAAQ,CAAR,OAAQ;AAClB,GAAY,CAAZ,UAAY;AAClB,GAAG,CAAH,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEf,GAAG,CAAC,OAAO,GAAG,OAAO,CAAC,GAAG,CAAC,QAAQ;AAClC,GAAG,CAAC,KAAK;AAET,KAAK,CAAC,aAAa;IACjB,WAAW,GAAE,MAAQ;IACrB,IAAI,GAAE,SAAW;IACjB,IAAI,EAAE,IAAI;;AAEZ,KAAK,CAAC,SAAS,IAAI,OAAO,EAAE,aAAa,CAAC,IAAI,CAAC,CAAC,EAAE,aAAa,CAAC,IAAI;AACpE,KAAK,CAAC,SAAS,MAAM,SAAS,CAAC,aAAa;AAa5C,EAAyE,AAAzE,uEAAyE;SAChE,OAAO,CAAC,YAAqC,EAAE,CAAC;IACvD,KAAK,CAAC,MAAM;IACZ,GAAG,CAAC,OAAO;YACH,KAAY,GAAK,CAAC;QACxB,MAAM,CAAC,IAAI,CAAC,KAAK;QACjB,EAAwG,AAAxG,sGAAwG;QACxG,EAAE,GAAG,OAAO,EAAE,CAAC;YACb,OAAO,GAAG,UAAU,KAAO,CAAC;gBAC1B,YAAY,CAAC,MAAM,CAAC,KAAK;gBACzB,MAAM,CAAC,MAAM,GAAG,CAAC;gBACjB,OAAO,GAAG,SAAS;YACrB,CAAC,EAAE,IAAI;QACT,CAAC;IACH,CAAC;AACH,CAAC;AAED,KAAK,CAAC,iBAAiB,IACrB,IAAY,EACZ,QAAgB,EAChB,SAAiB,EACjB,EAAU,EACV,QAAiB,EACjB,KAAc,GACX,CAAC;IACJ,EAAE,GAAG,OAAO,EAAE,CAAC;QACb,OAAO,GAAG,OAAO,CAAC,GAAG,CAAC,QAAQ,OApDN,OAAQ,cAoDa,CAAC,EAAE,QAAQ,EAAC,GAAK;QAlDtD,GAAG,CAmDP,IAAI,EACL,kCAAkC,EAAE,SAAS,CAAC,eAAe,EAAE,OAAO;IAE3E,CAAC;IAED,EAAE,GAAG,KAAK,EAAE,CAAC;QACX,KAAK,GAAG,OAAO,EAAE,MAAM,GAAK,CAAC;YAC3B,EAAiE,AAAjE,+DAAiE;gBA7DrD,WAAgC,cAgExC,EAAwB,AAAxB,sBAAwB;oBA9DhB,UAAY,UA+Dd,SAAS;oBACb,MAAM,GAAE,IAAM;oBACd,OAAO;yBAAI,YAAc,IAAE,gBAAkB;;oBAC7C,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,MAAM;;;gBAE7B,UAAU,EAAE,GAAG;gBAAE,OAAO,EAAE,CAAC;gBAAE,MAAM,EAAE,CAAC;eACxC,KAAK,CAAC,OAAO,CAAC,GAAG;QACrB,CAAC;IACH,CAAC;IAED,KAAK;QACH,OAAO;QACP,QAAQ;QACR,IAAI;QACJ,EAAE;QACF,SAAS;QACT,QAAQ;QACR,aAAa;QACb,IAAI,EAAE,KAAK;;AAEf,CAAC;eAEc,iBAAiB"}